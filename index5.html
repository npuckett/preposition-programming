<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P5.js Preposition Examples</title>
    <link rel="stylesheet" href="styles2.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
</head>
<body>
    <div class="container">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>P5.js Prepositions</h1>
                <p>Methods for converting language to code</p>
                <button class="menu-toggle" onclick="toggleSidebar()">Toggle Menu</button>
            </div>

            <div class="menu-section">
                <h3>Spatial Relationships</h3>
                <button class="menu-item" onclick="loadPreposition('above')">Above</button>
                <button class="menu-item" onclick="loadPreposition('below')">Below</button>
                <button class="menu-item" onclick="loadPreposition('between')">Between</button>
                <button class="menu-item" onclick="loadPreposition('among')">Among</button>
                <button class="menu-item" onclick="loadPreposition('beside')">Beside</button>
                <button class="menu-item" onclick="loadPreposition('behind')">Behind</button>
                <button class="menu-item" onclick="loadPreposition('beneath')">Beneath</button>
                <button class="menu-item" onclick="loadPreposition('within')">Within</button>
                <button class="menu-item" onclick="loadPreposition('through')">Through</button>
            </div>

            <div class="menu-section">
                <h3>Movement and Direction</h3>
                <button class="menu-item" onclick="loadPreposition('toward')">Toward</button>
                <button class="menu-item" onclick="loadPreposition('away')">Away</button>
                <button class="menu-item" onclick="loadPreposition('across')">Across</button>
                <button class="menu-item" onclick="loadPreposition('along')">Along</button>
                <button class="menu-item" onclick="loadPreposition('around')">Around</button>
                <button class="menu-item" onclick="loadPreposition('into')">Into</button>
                <button class="menu-item" onclick="loadPreposition('onto')">Onto</button>
                <button class="menu-item" onclick="loadPreposition('past')">Past</button>
                <button class="menu-item" onclick="loadPreposition('over')">Over</button>
                <button class="menu-item" onclick="loadPreposition('under')">Under</button>
            </div>

            <div class="menu-section">
                <h3>Time-based</h3>
                <button class="menu-item" onclick="loadPreposition('before')">Before</button>
                <button class="menu-item" onclick="loadPreposition('after')">After</button>
                <button class="menu-item" onclick="loadPreposition('during')">During</button>
                <button class="menu-item" onclick="loadPreposition('since')">Since</button>
                <button class="menu-item" onclick="loadPreposition('until')">Until</button>
            </div>
        </nav>

        <main class="main-content" id="mainContent">
            <div class="content-header">
                <h2 id="pageTitle">Welcome</h2>
                <a href="#" id="webEditorLink" class="web-editor-btn" target="_blank" style="display: none;">
                    Open in P5 Web Editor
                </a>
            </div>

            <div class="content-body">
                <!-- Welcome screen -->
                <div class="welcome-screen" id="welcomeScreen">
                    <h3>Welcome to P5.js Prepositions</h3>
                    <p>This collection contains interactive examples showing how spatial, directional, and temporal prepositions can be translated into P5.js sketches.</p>
                    <p>Select a preposition from the menu to explore its interactive example.</p>
                    <p><strong>24 examples total:</strong></p>
                    <p>9 Spatial Relationships</p>
                    <p>10 Movement and Direction</p>
                    <p>5 Time-based</p>
                </div>

                <!-- Sketch container -->
                <div class="sketch-container" id="sketchContainer">
                    <div class="sketch-description" id="sketchDescription">
                        <!-- Description will be loaded here -->
                    </div>
                    <div class="canvas-wrapper">
                        <div id="canvas"></div>
                    </div>
                </div>

                <!-- Loading state -->
                <div class="loading" id="loadingState" style="display: none;">
                    Loading sketch...
                </div>

                <!-- Error state -->
                <div class="error" id="errorState" style="display: none;">
                    Error loading sketch. Please try again.
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentSketch = null;
        let currentScript = null;

        // Preposition data
        const prepositions = {
            'above': { title: 'Above', jsFile: 'jsFiles/sketch-above.js', webEditorFile: 'webeditorjs/sketch-above.js' },
            'across': { title: 'Across', jsFile: 'jsFiles/sketch-across.js', webEditorFile: 'webeditorjs/sketch-across.js' },
            'after': { title: 'After', jsFile: 'jsFiles/sketch-after.js', webEditorFile: 'webeditorjs/sketch-after.js' },
            'along': { title: 'Along', jsFile: 'jsFiles/sketch-along.js', webEditorFile: 'webeditorjs/sketch-along.js' },
            'among': { title: 'Among', jsFile: 'jsFiles/sketch-among.js', webEditorFile: 'webeditorjs/sketch-among.js' },
            'around': { title: 'Around', jsFile: 'jsFiles/sketch-around.js', webEditorFile: 'webeditorjs/sketch-around.js' },
            'away': { title: 'Away', jsFile: 'jsFiles/sketch-away.js', webEditorFile: 'webeditorjs/sketch-away.js' },
            'before': { title: 'Before', jsFile: 'jsFiles/sketch-before.js', webEditorFile: 'webeditorjs/sketch-before.js' },
            'behind': { title: 'Behind', jsFile: 'jsFiles/sketch-behind.js', webEditorFile: 'webeditorjs/sketch-behind.js' },
            'below': { title: 'Below', jsFile: 'jsFiles/sketch-below.js', webEditorFile: 'webeditorjs/sketch-below.js' },
            'beneath': { title: 'Beneath', jsFile: 'jsFiles/sketch-beneath.js', webEditorFile: 'webeditorjs/sketch-beneath.js' },
            'beside': { title: 'Beside', jsFile: 'jsFiles/sketch-beside.js', webEditorFile: 'webeditorjs/sketch-beside.js' },
            'between': { title: 'Between', jsFile: 'jsFiles/sketch-between.js', webEditorFile: 'webeditorjs/sketch-between.js' },
            'during': { title: 'During', jsFile: 'jsFiles/sketch-during.js', webEditorFile: 'webeditorjs/sketch-during.js' },
            'into': { title: 'Into', jsFile: 'jsFiles/sketch-into.js', webEditorFile: 'webeditorjs/sketch-into.js' },
            'onto': { title: 'Onto', jsFile: 'jsFiles/sketch-onto.js', webEditorFile: 'webeditorjs/sketch-onto.js' },
            'over': { title: 'Over', jsFile: 'jsFiles/sketch-over.js', webEditorFile: 'webeditorjs/sketch-over.js' },
            'past': { title: 'Past', jsFile: 'jsFiles/sketch-past.js', webEditorFile: 'webeditorjs/sketch-past.js' },
            'since': { title: 'Since', jsFile: 'jsFiles/sketch-since.js', webEditorFile: 'webeditorjs/sketch-since.js' },
            'through': { title: 'Through', jsFile: 'jsFiles/sketch-through.js', webEditorFile: 'webeditorjs/sketch-through.js' },
            'toward': { title: 'Toward', jsFile: 'jsFiles/sketch-toward.js', webEditorFile: 'webeditorjs/sketch-toward.js' },
            'under': { title: 'Under', jsFile: 'jsFiles/sketch-under.js', webEditorFile: 'webeditorjs/sketch-under.js' },
            'until': { title: 'Until', jsFile: 'jsFiles/sketch-until.js', webEditorFile: 'webeditorjs/sketch-until.js' },
            'within': { title: 'Within', jsFile: 'jsFiles/sketch-within.js', webEditorFile: 'webeditorjs/sketch-within.js' }
        };

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('visible');
            } else {
                sidebar.classList.toggle('hidden');
                mainContent.classList.toggle('expanded');
            }
        }

        function showLoading() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('sketchContainer').classList.remove('active');
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('loadingState').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('sketchContainer').classList.remove('active');
            document.getElementById('loadingState').style.display = 'none';
            const errorDiv = document.getElementById('errorState');
            errorDiv.textContent = message || 'Error loading sketch. Please try again.';
            errorDiv.style.display = 'block';
        }

        function showSketch() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('sketchContainer').classList.add('active');
        }

        function showWelcome() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('sketchContainer').classList.remove('active');
            document.getElementById('welcomeScreen').style.display = 'block';
            document.getElementById('pageTitle').textContent = 'Welcome';
            document.getElementById('webEditorLink').style.display = 'none';
        }

        function cleanupSketch() {
            console.log('Cleaning up previous sketch...');
            
            // Remove current sketch
            if (currentSketch && typeof currentSketch.remove === 'function') {
                try {
                    currentSketch.remove();
                    console.log('Previous sketch removed successfully');
                } catch (e) {
                    console.log('Error removing sketch:', e);
                }
                currentSketch = null;
            }

            // Remove current script
            if (currentScript) {
                currentScript.remove();
                currentScript = null;
                console.log('Previous script removed');
            }

            // Clear canvas
            const canvasContainer = document.getElementById('canvas');
            if (canvasContainer) {
                canvasContainer.innerHTML = '';
                console.log('Canvas cleared');
            }

            // Clear any global p5 functions - be more careful about this
            try {
                if (window.setup) delete window.setup;
                if (window.draw) delete window.draw;
                if (window.mousePressed) delete window.mousePressed;
                if (window.mouseDragged) delete window.mouseDragged;
                if (window.mouseReleased) delete window.mouseReleased;
                if (window.keyPressed) delete window.keyPressed;
                if (window.windowResized) delete window.windowResized;
                console.log('Global p5 functions cleared');
            } catch (e) {
                console.log('Error clearing global functions:', e);
            }
        }

        async function loadDescription(preposition) {
            try {
                const htmlFile = `preposition-${preposition}.html`;
                const response = await fetch(htmlFile);
                if (!response.ok) throw new Error(`Failed to load ${htmlFile}`);
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Extract description from the HTML file
                const description = doc.querySelector('.description') || doc.querySelector('body');
                if (description) {
                    document.getElementById('sketchDescription').innerHTML = description.innerHTML;
                } else {
                    document.getElementById('sketchDescription').innerHTML = `<h3>${prepositions[preposition].title}</h3><p>Interactive P5.js sketch demonstrating the preposition "${preposition}".</p>`;
                }
            } catch (error) {
                console.warn('Could not load description:', error);
                document.getElementById('sketchDescription').innerHTML = `<h3>${prepositions[preposition].title}</h3><p>Interactive P5.js sketch demonstrating the preposition "${preposition}".</p>`;
            }
        }

        async function setupWebEditorLink(preposition) {
            try {
                const response = await fetch(prepositions[preposition].webEditorFile);
                if (!response.ok) throw new Error('Could not load web editor file');
                
                const code = await response.text();
                const encodedCode = encodeURIComponent(code);
                const webEditorLink = document.getElementById('webEditorLink');
                webEditorLink.href = `https://editor.p5js.org/?code=${encodedCode}`;
                webEditorLink.style.display = 'inline-block';
            } catch (error) {
                console.warn('Could not setup web editor link:', error);
                document.getElementById('webEditorLink').style.display = 'none';
            }
        }

        async function loadPreposition(preposition) {
            console.log('=== Loading preposition:', preposition, '===');
            
            if (!prepositions[preposition]) {
                console.error(`Preposition "${preposition}" not found in data.`);
                showError(`Preposition "${preposition}" not found.`);
                return;
            }

            showLoading();

            try {
                // Update active menu item
                document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
                if (event && event.target) {
                    event.target.classList.add('active');
                }

                // Update title
                const title = `Preposition: ${prepositions[preposition].title}`;
                document.getElementById('pageTitle').textContent = title;
                console.log('Updated title to:', title);

                // Clean up previous sketch
                cleanupSketch();

                // Load description and web editor link in parallel
                console.log('Loading description and web editor link...');
                await Promise.all([
                    loadDescription(preposition),
                    setupWebEditorLink(preposition)
                ]);

                // Load the sketch
                console.log('Loading sketch file:', prepositions[preposition].jsFile);
                await new Promise((resolve, reject) => {
                    currentScript = document.createElement('script');
                    currentScript.src = prepositions[preposition].jsFile + '?t=' + Date.now();
                    
                    currentScript.onload = () => {
                        console.log(`Successfully loaded sketch script: ${preposition}`);
                        
                        // Check if canvas div exists and if P5 sketch is running
                        setTimeout(() => {
                            const canvasDiv = document.getElementById('canvas');
                            const canvas = canvasDiv ? canvasDiv.querySelector('canvas') : null;
                            
                            if (canvas) {
                                console.log('P5.js canvas found and sketch appears to be running');
                                resolve();
                            } else {
                                console.log('Warning: P5.js canvas not found after loading script');
                                console.log('Canvas div content:', canvasDiv ? canvasDiv.innerHTML : 'Canvas div not found');
                                // Check if there are global p5 functions available
                                console.log('Global setup function exists:', typeof window.setup === 'function');
                                console.log('Global draw function exists:', typeof window.draw === 'function');
                                
                                // Try to manually trigger setup if it exists but canvas doesn't
                                if (typeof window.setup === 'function' && !canvas) {
                                    console.log('Attempting to manually trigger setup...');
                                    try {
                                        window.setup();
                                    } catch (e) {
                                        console.log('Error manually triggering setup:', e);
                                    }
                                }
                                resolve();
                            }
                        }, 1000); // Give more time for P5 to initialize
                    };
                    
                    currentScript.onerror = () => {
                        const error = new Error(`Failed to load ${prepositions[preposition].jsFile}`);
                        console.error('Script loading error:', error);
                        reject(error);
                    };
                    
                    console.log('Appending script to document head...');
                    document.head.appendChild(currentScript);
                });

                console.log('Showing sketch container...');
                showSketch();

                // Auto-hide sidebar on mobile after selection
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.remove('visible');
                }

                console.log('=== Successfully completed loading preposition:', preposition, '===');

            } catch (error) {
                console.error('Error loading preposition:', error);
                showError(`Failed to load "${preposition}": ${error.message}`);
            }
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            if (window.innerWidth > 768) {
                sidebar.classList.remove('visible');
                if (!sidebar.classList.contains('hidden')) {
                    mainContent.classList.remove('expanded');
                }
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                showWelcome();
                document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
                cleanupSketch();
            }
        });

        // Initialize
        showWelcome();
    </script>
</body>
</html>
